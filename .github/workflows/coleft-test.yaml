name: Run Codeleft CLI

# Trigger the workflow on push
on:
  push:
    branches:
      - main

jobs:
  run-codeleft-cli:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Download the codeleft-cli binary from GitHub Releases
      - name: Download codeleft-cli
        run: |
          VERSION=v0.1.1
          OS=Linux
          ARCH=x86_64
          ASSET_NAME=codeleft-cli_${OS}_${ARCH}.tar.gz
          DOWNLOAD_URL="https://github.com/henrylamb/codeleft-cli/releases/download/${VERSION}/${ASSET_NAME}"
          
          echo "Downloading codeleft-cli from $DOWNLOAD_URL"
          curl -L -o codeleft-cli.tar.gz $DOWNLOAD_URL

          # Verify the file is a gzip archive
          if ! file codeleft-cli.tar.gz | grep -q "gzip compressed data"; then
            echo "Error: Downloaded file is not a valid gzip archive."
            echo "Contents of the downloaded file:"
            head codeleft-cli.tar.gz
            exit 1
          fi

      # 3. Extract the binary
      - name: Extract codeleft-cli
        run: |
          tar -xzf codeleft-cli.tar.gz
          chmod +x codeleft-cli
          sudo mv codeleft-cli /usr/local/bin/

      # 4. Verify installation
      - name: Verify codeleft-cli Installation
        run: |
          codeleft-cli --version

      # 4.1. List repository files for debugging
      - name: List Repository Files
        run: |
          echo "Listing all files and directories:"
          ls -R

      # 4.2. Print current working directory
      - name: Print Current Directory
        run: |
          echo "Current Directory:"
          pwd

      # 5. Change directory if inside 'codeleft-cli' and execute the command
      - name: Execute codeleft-cli Command
        run: |
          # Store the current directory
          CURRENT_DIR=$(pwd)
          
          # Check if the current directory is 'codeleft-cli'
          if [ "$(basename "$CURRENT_DIR")" = "codeleft-cli" ]; then
            echo "Currently inside 'codeleft-cli' directory. Navigating to repository root."
            cd ..
          else
            echo "Not inside 'codeleft-cli' directory. Proceeding."
          fi
          
          # Verify the presence of .codeleft directory
          if [ ! -d ".codeleft" ]; then
            echo "Error: .codeleft directory does not exist in the repository root."
            exit 1
          fi
          
          # Execute the codeleft-cli command
          codeleft-cli --asses-coverage --threshold-percent=80 --threshold-grade=A --tools "SOLID,OWASP-TOP-10,PR Ready"
